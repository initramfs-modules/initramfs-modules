FROM ghcr.io/initramfs-modules/kernel-tiny as kernel

FROM docker.io/alpine:edge

RUN apk add --no-cache \
    alpine-sdk \
    asciidoc \
    bash \
    binutils \
    blkid \
    btrfs-progs \
    busybox \
    bzip2 \
    coreutils \
    cpio \
    cryptsetup \
    curl \
    dash \
    dhclient \
    dmraid \
    dosfstools \
    e2fsprogs \
    eudev \
    findmnt \
    git \
    gpg \
    grep \
    gummiboot \
    iputils \
    kbd \
    kmod-dev \
    libnfsidmap \
    linux-virt \
    losetup \
    lvm2 \
    make \
    mdadm \
    mtools \
    multipath-tools \
    musl-fts-dev \
    nbd \
    nfs-utils \
    ntfs-3g \
    open-iscsi \
    openssh \
    ovmf \
    parted \
    partx \
    pigz \
    procps \
    qemu-img \
    qemu-system-x86_64 \
    sed \
    sfdisk \
    squashfs-tools \
    sudo \
    util-linux-misc \
    xorriso \
    xz \
    dracut-modules

RUN ln -sf /sbin/poweroff /sbin/shutdown && \
  ln -sf /usr/bin/dash /bin/dash && \
  ln -sf /bin/sh /usr/bin/sh && \
  rm -rf /boot/* && \
  rm -rf /usr/lib/dracut/modules.d/* /usr/lib/dracut/test/* && \
  cp -a /home/runner/work/initramfs-modules/initramfs-modules/dracut/modules.d /usr/lib/dracut/ && \
  cp -a /home/runner/work/initramfs-modules/initramfs-modules/dracut/test /usr/lib/dracut/ && \
  cd /usr/lib/dracut && \
  curl https://patch-diff.githubusercontent.com/raw/dracutdevs/dracut/pull/2130.patch | git apply --verbose

COPY --from=kernel /boot /boot
