FROM docker.io/alpine:latest

# module dependencies
RUN apk add squashfs-tools binutils curl btrfs-progs openssh nfs-utils libnfsidmap dhclient lvm2 cryptsetup gpg open-iscsi multipath-tools losetup dash mdadm nbd partx sed dmraid

# dependencies to run tests
RUN apk add linux-virt qemu-img qemu-system-x86_64 e2fsprogs git mdev-conf util-linux-misc make rsync sfdisk strace grep cpio qemu-block-nfs qemu-modules

# Uninstall mkinitfs
RUN rm -rf /sbin/mkinitfs /usr/share/mkinitfs /etc/mkinitfs /boot/initramfs-*

RUN ln -sf /boot/vmlinuz-virt /boot/vmlinuz-$(cd /lib/modules; ls -1 | tail -1)

# Grab all dracut modules
RUN apk add dracut zfs-dracut --update-cache --repository https://dl-cdn.alpinelinux.org/alpine/edge/testing --allow-untrusted

RUN cp /usr/bin/dracut /usr/lib/dracut/dracut.sh
RUN cp /sbin/poweroff /sbin/shutdown
RUN cp /usr/bin/dash /bin/dash
