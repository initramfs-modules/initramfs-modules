FROM docker.io/alpine:latest

# dracut
RUN apk add dracut-modules-network zfs-dracut --update-cache --repository https://dl-cdn.alpinelinux.org/alpine/edge/testing --allow-untrusted

# tests
RUN apk add dracut-tests --update-cache --repository https://dl-cdn.alpinelinux.org/alpine/edge/testing --allow-untrusted

# TODO - create dracut-modules-X upstream
# dracut-modules-btrfs - btrfs-progs - btrfs
# dracut-modules-crypt - cryptsetup - crypt
# dracut-modules-dash - dash - dash
# dracut-modules-dmraid - dmraid, partx - dmraid
# dracut-modules-gpg - gpg - crypt-gpg
# dracut-modules-mdadm - mdadm, partx - mdraid
# dracut-modules-lvm - lvm2 - lvm, lvmmerge, lvmthinpool-monitor
# dracut-modules-multipath - multipath-tools, partx - multipath
# dracut-modules-openssh - openssh, dracut-modules-network - ssh-client
# dracut-modules-squashfs - squashfs-tools - squash
RUN apk add btrfs-progs cryptsetup dash dmraid partx gpg mdadm lvm2 multipath-tools partx openssh squashfs-tools

RUN apk add linux-virt mdev-conf sed

# module dependencies for networking
# RUN apk add nfs-utils libnfsidmap dhclient open-iscsi nbd curl

# RUN apk add networkmanager

# additional dependencies to run tests for networking
# RUN apk add qemu-block-nfs qemu-modules

# makedepends
#RUN apk add asciidoc musl-fts-dev kmod-dev bash coreutils blkid findmnt eudev

# alpine-sdk
#RUN apk add alpine-sdk sudo

# Uninstall most mkinitfs files. mkinitfs gets pulled in by linux-virt
RUN rm -rf /sbin/mkinitfs /usr/share/mkinitfs /etc/mkinitfs /boot/initramfs-*

RUN ln -sf /boot/vmlinuz-virt /boot/vmlinuz-$(cd /lib/modules; ls -1 | tail -1)

RUN cp /sbin/poweroff /sbin/shutdown
RUN cp /usr/bin/dash /bin/dash
RUN cp /bin/sh /usr/bin/sh
