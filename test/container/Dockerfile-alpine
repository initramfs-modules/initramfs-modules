FROM docker.io/alpine:latest

# module dependencies to improve on busybox, needed to pass test 14 mdraid module needs it
# sed: bad regex '(RUN|IMPORT\{program\})\+?="[[:alpha:]': Missing ']'
RUN apk add sed

# multipath-tools - multipath
# btrfs-progs - btrfs
# lvm2 - lvm, lvmmerge, lvmthinpool-monitor
# cryptsetup - crypt
# gpg - crypt-gpg
# mdadm - mdraid
# dmraid - dmraid
# partx - dmraid, mdraid, multipath
# dash - dash
# openssh - ssh-client
# squashfs-tools - squash
RUN apk add btrfs-progs lvm2 cryptsetup gpg mdadm dmraid multipath-tools partx dash openssh squashfs-tools

# module dependencies for networking
# RUN apk add nfs-utils libnfsidmap dhclient open-iscsi nbd curl

# dracut-tests
RUN apk add e2fsprogs grep make qemu-img qemu-system-x86_64 sfdisk strace sudo util-linux-misc

# additional dependencies to run tests
RUN apk add linux-virt git mdev-conf rsync cpio

# additional dependencies to run tests for networking
# RUN apk add qemu-block-nfs qemu-modules

# Uninstall mkinitfs
RUN rm -rf /sbin/mkinitfs /usr/share/mkinitfs /etc/mkinitfs /boot/initramfs-*

RUN ln -sf /boot/vmlinuz-virt /boot/vmlinuz-$(cd /lib/modules; ls -1 | tail -1)

# Grab all dracut modules
RUN apk add dracut zfs-dracut --update-cache --repository https://dl-cdn.alpinelinux.org/alpine/edge/testing --allow-untrusted

RUN cp /usr/bin/dracut /usr/lib/dracut/dracut.sh
RUN cp /sbin/poweroff /sbin/shutdown
RUN cp /usr/bin/dash /bin/dash
